<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Quiz</title>

  <style>
    @media screen and (max-width: 1000px) {

      html,
      body {
        font-size: 100%;
      }

      button {
        width: 100%;
        font-size: 100%;
      }
    }
  </style>
</head>

<body>
  <form name="myform">
    <input name="myfile" type="file" />
  </form>

  <div id="state"></div>

  <div style="margin-top: 20px;">
    <form name="range_question_form">
      出題範囲
      <input type="number" min="1" max="99999" id="no_start" name="no_question_start">
      &nbsp;〜&nbsp;
      <input type="number" min="1" max="99999" id="no_finish" name="no_question_finish">
      <button id="range_qustion" type="button" style="margin-top: 20px;" onclick="range_question();">範囲決定</button>
    </form>
  </div>

  <hr style="margin-top:20px;" />
  <p>
    <button id="other_question" type="button" onclick="other_question();">出題</button>
  </p>

  <p>
    No.&nbsp;<span id="no"></span>
  </p>

  <p>
    <span id="question"></span>
  </p>

  <p style="margin-top:50px;">
    <button id="visible_answer" type="button" onclick="visible_answer();">答え</button>
  </p>

  <p>
    <span id="answer"></span>
  </p>

  <p style="margin-top:50px;">
    <button id="wrong_answer" style="visibility:hidden;" type="button" onclick="wrong_answer();">間違えちまった</button>
  </p>

  <hr style="margin-top:50px;" />
  <p>
    答え確認済み(同じ問題は出ません)
    <button id="clear_finish" type="button" onclick="clear_finish();">クリア</button>
  </p>
  <div id="finished_no" style="width:100%;word-wrap: break-word">
  </div>

</body>

<script>
  if (localStorage.getItem('quiz') !== null) {
    var _data = localStorage.getItem('quiz');
    data = JSON.parse(_data);
    document.getElementById('state').innerText = 'データは取得済みです';
  }

  var form = document.forms.myform;

  form.myfile.addEventListener('change', function (e) {

    var result = e.target.files[0];
    var reader = new FileReader();
    reader.readAsText(result);

    reader.addEventListener('load', function () {
      localStorage.removeItem('quiz');
      data = JSON.parse(reader.result);
      localStorage.setItem('quiz', JSON.stringify(data));
    })
  })

  var finished_answer = [];
  var finished_answer_display = [];
  var _no = null;

  const _get_unfinished_no = () => {
    // if (data.length == finished_answer.length) {
    if ((no_question_finish - no_question_start + 1) == finished_answer.length) {
      alert('全て出題したので初期化します');
      finished_answer = [];
      finished_answer_display = [];
      document.getElementById('finished_no').innerText = finished_answer_display;
    }

    find = false;
    while (find == false) {
      // _no_ = Math.floor(Math.random() * data.length);
      _no_ = Math.floor(Math.random() * (no_question_finish - no_question_start + 1)) + no_question_start;

      if (finished_answer.includes(_no_) == false) {
        find = true;
      };
    }
    return _no_;
  }

  const _put_finished_no = (_no_) => {
    if (finished_answer.includes(_no_) == true) {
      return false;
    };

    finished_answer.unshift(_no_);
    finished_answer_display.unshift(_no_ + 1);
    document.getElementById('finished_no').innerText = finished_answer_display;
  }

  const other_question = () => {
    document.getElementById('wrong_answer').style.visibility = 'hidden';

    _no = _get_unfinished_no();

    var _question = data[_no].no;
    document.getElementById('no').innerText = _question;

    var _question = data[_no].q;
    document.getElementById('question').innerText = _question;

    document.getElementById('answer').innerText = '';
  }

  const clear_finish = () => {
    finished_answer = [];
    finished_answer_display = [];
    document.getElementById('no').innerText = '';
    document.getElementById('question').innerText = '';
    document.getElementById('answer').innerText = '';
    document.getElementById('finished_no').innerText = finished_answer_display;
  }

  const visible_answer = () => {
    if (_no == null) {
      return false;
    }

    var _answer = data[_no].a;
    document.getElementById('answer').innerText = _answer;
    document.getElementById('wrong_answer').style.visibility = 'visible';


    _put_finished_no(_no);
  }

  const wrong_answer = () => {
    finished_answer.shift();
    finished_answer_display.shift();
    document.getElementById('finished_no').innerText = finished_answer_display;
  }

  const range_question = () => {
    no_question_start = document.forms.range_question_form.no_question_start.value;
    if (no_question_start >= 1 && no_question_start <= data.length) {
      no_question_start = no_question_start - 1;
    } else {
      no_question_start = 0;
      document.forms.range_question_form.no_question_start.value = no_question_start + 1;
    }

    no_question_finish = document.forms.range_question_form.no_question_finish.value;
    if (no_question_finish >= 1 && no_question_finish <= data.length) {
      no_question_finish = no_question_finish - 1;
    } else {
      no_question_finish = data.length - 1;
      document.forms.range_question_form.no_question_finish.value = no_question_finish + 1;
    }
  }

</script>

</html>