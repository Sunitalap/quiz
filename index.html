<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <!-- <meta name=”viewport” content=”width=device-width,initial-scale=1.0″> -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Quiz</title>

  <style>
    @media screen and (max-width: 1000px) {

      html,
      body {
        font-size: 100%;
      }

      button {
        width: 100%;
        font-size: 100%;
      }
    }
  </style>

  <script>

    // var data = [
    //   {
    //     "no": 1,
    //     "q": "quest_1",
    //     "a": "answer_1"
    //   },
    //   {
    //     "no": 2,
    //     "q": "quest_2",
    //     "a": "answer_2"
    //   },
    //   {
    //     "no": 3,
    //     "q": "quest_3",
    //     "a": "answer_3"
    //   }
    // ];

    var requestURL = 'quiz.json';

    // function getJson() {
    const get_json = () => {
      var xmlhttp = new XMLHttpRequest();

      xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4) {
          if (xmlhttp.status == 200) {
            data = JSON.parse(xmlhttp.responseText);
            localStorage.setItem('quiz', data);
            // console.log(data);
          } else {
          }
        }
      }
      xmlhttp.open('GET', requestURL);
      xmlhttp.send();
    }

    // get_json();

  </script>
</head>

<body>
  <form name="myform">
    <input name="myfile" type="file" />
  </form>

  <p>
    <span id="state"></span>
  </p>

  <p>
    <button id="other_qustion" type="button" onclick="other_qustion();">出題</button>
  </p>

  <p>
    No.&nbsp;<span id="no"></span>
  </p>

  <p>
    <span id="question"></span>
  </p>

  <p style="margin-top:50px;">
    <button id="visible_answer" type="button" onclick="visible_answer();">答え</button>
  </p>

  <p>
    <span id="answer"></span>
  </p>

  <hr style="margin-top:50px;" />
  <p>
    答え確認済み(同じ問題は出ません)
    <button id="clear_finish" type="button" onclick="clear_finish();">クリア</button>
    &nbsp;<span id="finished_no"></span>
  </p>

</body>

<script>
  if (localStorage.getItem('quiz') !== null) {
    var _data = localStorage.getItem('quiz');
    data = JSON.parse(_data);
    document.getElementById('state').innerText = 'データは取得済みです';
  }

  var form = document.forms.myform;

  form.myfile.addEventListener('change', function (e) {

    var result = e.target.files[0];
    var reader = new FileReader();
    reader.readAsText(result);

    reader.addEventListener('load', function () {
      // console.log(JSON.parse(reader.result));
      localStorage.removeItem('quiz');
      data = JSON.parse(reader.result);
      localStorage.setItem('quiz', JSON.stringify(data));
    })
  })

  var finished_answer = [];
  var finished_answer_display = [];

  var _no = null;
  // console.log(data);
  // console.log(data.length);
  // console.log(data[0].no, data[0].q, data[0].a);

  const _get_unfinished_no = () => {
    if (data.length == finished_answer.length) {
      alert('全て出題したので初期化します');
      finished_answer = [];
      finished_answer_display = [];
    }

    find = false;
    while (find == false) {
      _no_ = Math.floor(Math.random() * data.length);
      if (finished_answer.includes(_no_) == false) {
        find = true;
      };
    }
    return _no_;
  }

  const _put_finished_no = (_no_) => {
    if (finished_answer.includes(_no_) == true) {
      return false;
    };

    finished_answer.unshift(_no_);
    finished_answer_display.unshift(_no_ + 1);
    // console.log(finished_answer);
    document.getElementById('finished_no').innerText = finished_answer_display;
  }

  const other_qustion = () => {
    _no = _get_unfinished_no();

    var _question = data[_no].no;
    document.getElementById('no').innerText = _question;

    var _question = data[_no].q;
    document.getElementById('question').innerText = _question;

    document.getElementById('answer').innerText = '';
  }

  const clear_finish = () => {
    finished_answer = [];
    finished_answer_display = [];
    document.getElementById('no').innerText = '';
    document.getElementById('question').innerText = '';
    document.getElementById('answer').innerText = '';
    document.getElementById('finished_no').innerText = finished_answer_display;
  }

  const visible_answer = () => {
    if (_no == null) {
      return false;
    }

    var _answer = data[_no].a;
    document.getElementById('answer').innerText = _answer;

    _put_finished_no(_no);
  }

</script>

</html>